<html>
	<head>
		<link rel="stylesheet" type="text/css" href="styles.css">
  		<h1>COVID-19 Deaths by Race</h1>
  	</head>
	
	<script src='https://d3js.org/d3.v5.min.js'></script>
	<body onload='init()'>
	
		<p class="blocktext">REPLACE ME! Number of deaths reported in this table are the 
		total number of deaths received and coded as of the date of analysis, and do not 
		represent all deaths that occurred in that period. Data during this period are 
		incomplete because of the lag in time between when the death occurred and when 
		the death certificate is completed, submitted to NCHS and processed for reporting 
		purposes. This delay can range from 1 week to 8 weeks or more.</p>
		
		<div id="chart" style="text-align:center;">
			<svg width=900 height=600></svg>
		</div>

		<p class="blocktext">
		<a href="#" class="previous">&laquo; Previous</a>
		<a href="#" class="next">Next &raquo;</a>
		</p>

<script>

async function init() {

const data = await d3.csv('https://raw.githubusercontent.com/ryanpmurray1/covid19deathsbyrace/master/Provisional_Death_Counts_for_Coronavirus_Disease__COVID-19___Weekly_State-Specific_Data_Updates.csv');
console.log(data);
dataclean = data.filter( function (d) {
	if (d.Indicator == "Count of COVID-19 deaths" & d.State != "United States") {
		return d };
});
console.log(dataclean);

var subgroups = data.columns.slice(3,9);
console.log(subgroups);
var groups = d3.map(dataclean, function(d){return(d.State)}).keys();
console.log(groups);

var datacols = [
	'Non-Hispanic White',
	'Non-Hispanic Black or African American',
	'Hispanic or Latino',
	'Non-Hispanic Asian',
	'Non-Hispanic American Indian or Alaska Native',
	'Other' ];
xvar = 'State';
yvar = 'Non-Hispanic White';
rowselect = 'Indicator';

// Convert columns to numeric
dataclean.forEach(function(d) {
	d[datacols[0]] = +d[datacols[0]]
	d[datacols[1]] = +d[datacols[1]]
	d[datacols[2]] = +d[datacols[2]]
	d[datacols[3]] = +d[datacols[3]]
	d[datacols[4]] = +d[datacols[4]]
	d[datacols[5]] = +d[datacols[5]];
});

// Define the margins and dimensions
topmargin = 50;
bottommargin = 50;
leftmargin = 50;
rightmargin = 50;

w = 900 - leftmargin - rightmargin;
h = 500 - topmargin - bottommargin;

// Define the colors
var colorarray = ['#003f5c','#ffa600','#444e86','#ff6e54','#955196','#dd5182'];

// Legend parameters
var legenddata = [
	{x: +leftmargin+40,		c: colorarray[0], t: "White"},
	{x: +leftmargin+140,	c: colorarray[1], t: "Black"},
	{x: +leftmargin+240, 	c: colorarray[2], t: "Hispanic"},
	{x: +leftmargin+360, 	c: colorarray[3], t: "Asian"},
	{x: +leftmargin+460, 	c: colorarray[4], t: "Am. Indian or Alaska Native"},
	{x: +leftmargin+720, 	c: colorarray[5], t: "Other"}]
circlerad = 8;
textoffset = 10;
yloc = 20;
textsize = "17px"

// Legend circles
d3.select('svg')
	.selectAll("circle")
	.data(legenddata)
	.enter().append("circle")
    	.attr("cx", function(d) { return d.x; })
		.attr("cy", yloc)
		.attr("r", circlerad)
		.style("fill", function(d) { return d.c; });

// Legend text
d3.select('svg')
	.selectAll("text")
	.data(legenddata)
	.enter().append("text")
		.attr("x", function(d) { return d.x + textoffset; })
		.attr("y", yloc)
		.text(function(d) { return d.t; })
		.style("font-size", textsize)
		.attr("alignment-baseline","middle");


var xdomain = dataclean.map(function(d) { return d.State}).keys();
console.log("xdomain:");
console.log(xdomain);

ydomain = [0,Math.ceil(d3.max(dataclean, function(d)
{ 
	if (d.State != "United States") {
		sumtotal = d['Non-Hispanic White'] +
			d['Non-Hispanic Black or African American'] +
			d['Hispanic or Latino'] +
			d['Non-Hispanic Asian'] +
			d['Non-Hispanic American Indian or Alaska Native'] +
			d['Other'];
		console.log(sumtotal);
		return sumtotal;
	} else { return 0; }
})/1000)*1000];
console.log("ydomain:");
console.log(ydomain);


// X-axis (bottom)
var x = d3.scaleBand()
	.domain(groups)
	.range([0,w])
	.padding(0.2);
d3.select('svg')
    .append("g")
    .attr("transform","translate("+50+","+(h+50)+")")
	.call(d3.axisBottom(x))
    .selectAll("text")
    	.attr("transform", "translate(-10,0)rotate(-45)")
    	.style("text-anchor", "end")
    	.style("font-size", "12px");

// Y-axis (left)
var y = d3.scaleLinear()
	.domain(ydomain)
	.range([h,0]);
d3.select('svg')
    .append("g")
    .attr("transform","translate("+50+","+50+")")
    .call(d3.axisLeft(y).ticks(20));
    
// Y-axis (right)
var y = d3.scaleLinear()
	.domain(ydomain)
	.range([h,0]);
d3.select('svg')
    .append("g")
    .attr("transform","translate("+850+","+50+")")
    .call(d3.axisRight(y).ticks(20));

// Y-gridlines
d3.select('svg')
	.append("g")			
		.attr("class", "grid")
		.attr("transform","translate("+leftmargin+","+rightmargin+")")
		.call(d3.axisLeft(y).ticks(20).tickSize(-w).tickFormat(""));
  
// color palette = one color per subgroup
var color = d3.scaleOrdinal()
    .domain(subgroups)
    .range(colorarray);
    
// Stack the data
var stackedData = d3.stack()
	.keys(subgroups)
	(dataclean);

console.log(stackedData)

// Show the bars
d3.select('svg')
	.append("g")
	.attr('transform',"translate("+leftmargin+","+rightmargin+")")
    .selectAll("g")
    // Enter in the stack data = loop key per key = group per group
    .data(stackedData)
    .enter().append("g")
      .attr("fill", function(d) { return color(d.key); })
      .selectAll("rect")
      .data(function(d) { return d; })
      .enter().append("rect")
        .attr("x", function(d) { return x(d.data.State); })
        //.attr("y", function(d) { return y(d[1]); })
        .attr("y", function(d) { return y(0); })
        //.attr("height", function(d) { return y(d[0]) - y(d[1]); })
        .attr("height", function(d) { return h-y(0); })
        .attr("width",x.bandwidth());

// Create the animated effect
d3.select('svg')
	.selectAll("rect")
  	.transition()
  	.duration(800)
  	.attr("y", function(d) { return y(d[1]); })
  	.attr("height", function(d) { return y(d[0]) - y(d[1]); })
  	.delay(function(d,i){console.log(i) ; return(i*10)});

// Total deaths text
usdata = data.filter( function (d) {
	if (d.Indicator == "Count of COVID-19 deaths" & d.State == "United States") {
		return d };
});

// Convert columns to numeric
usdata.forEach(function(d) {
	d[datacols[0]] = +d[datacols[0]]
	d[datacols[1]] = +d[datacols[1]]
	d[datacols[2]] = +d[datacols[2]]
	d[datacols[3]] = +d[datacols[3]]
	d[datacols[4]] = +d[datacols[4]]
	d[datacols[5]] = +d[datacols[5]];
});

// Calculate the total U.S. deaths
console.log(usdata);
totaldeaths = usdata[0]['Non-Hispanic White'] +
	usdata[0]['Non-Hispanic Black or African American'] +
	usdata[0]['Hispanic or Latino'] +
	usdata[0]['Non-Hispanic Asian'] +
	usdata[0]['Non-Hispanic American Indian or Alaska Native'] +
	usdata[0]['Other'];

// Display the Total U.S. Deaths text
d3.select('svg')
	.selectAll("text")
	//.transition()
	//.duration(800)
	.data(data)
	.enter().append("text")
		.attr("x", 300)
		.attr("y", 550)
		//.text(function(d) { return "TOTAL U.S. DEATHS:"; })
		.text("Total U.S. Deaths: " + totaldeaths)
		.style("font-size", "25px")
		.attr("alignment-baseline","middle")
		//.delay(function(d,i){console.log(i) ; return(i*10)});
    
// Annotation line for NYC
/*d3.select('svg')
	.selectAll("line")
	.data(data)
	.enter().append('path')
		.attr('d', d3.line()([[565, 61], [565, 61]]))
		.attr('stroke', 'black')
		.attr('marker-start', 'url(#arrow)')
		.attr('marker-end', 'url(#arrow)')
		.attr('fill', 'none');*/

// Create the animated effect
/*d3.select('svg')
	.select("path")
  	.transition()
  	.duration(800)
  	.attr('d', d3.line()([[400, 90], [565, 61]]))
  			.attr('stroke', 'black')
		.attr('marker-start', 'url(#arrow)')
		.attr('marker-end', 'url(#arrow)')
		.attr('fill', 'none')
  	.delay(function(d,i){console.log(i) ; return(i*50)});*/
  	
// Annotation text for NYC
d3.select('svg')
	.selectAll("text")
	.data(data)
	.enter().append("text")
		.attr("x", 400)
		.attr("y", 90)
		.text("New York City: ")
		.style("font-size", "20px")
		.attr("alignment-baseline","middle")

// Legend text
d3.select('svg')
	.selectAll("text")
	.data(legenddata)
	.enter().append("text")
		.attr("x", function(d) { return d.x + textoffset; })
		.attr("y", yloc)
		.text(function(d) { return d.t; })
		.style("font-size", textsize)
		.attr("alignment-baseline","middle");


}
</script>
</body>
</html>